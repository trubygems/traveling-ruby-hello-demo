name: Package

on:
  push:


jobs:
  package:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        example: ["hello", "gem", "native", "pact_broker"]
        ruby-version: ["3.4.7"]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - uses: ruby/setup-ruby@v1.267.0
      with:
        ruby-version: ${{ matrix.ruby-version }}
        # bundler-cache: true
    - name: Cache gems
      if: matrix.example != 'hello'
      id: cache-gems
      uses: actions/cache@v4
      with:
        path: examples/${{ matrix.example }}/build/vendor
        key: vendor-${{ matrix.example }}-${{ hashFiles(format('examples/{0}/packaging/Gemfile.lock', matrix.example)) }}-ruby-${{ matrix.ruby-version }}
    - name: Install dependencies
      if: matrix.example != 'hello'
      run: bundle install
      working-directory: examples/${{ matrix.example }}
    - name: Build
      if: matrix.example == 'hello'
      run: rake package
      working-directory: examples/${{ matrix.example }}
    - name: Build
      if: matrix.example != 'hello'
      run: bundle exec rake package
      working-directory: examples/${{ matrix.example }}
    - name: Show standalone packages
      run: ls examples/${{ matrix.example }}/pkg
    - name: Upload standalone packages
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.example }}-pkg
        path: examples/${{ matrix.example }}/pkg
  test:
    defaults:
      run:
        shell: ${{ matrix.shell }}
    needs: [package]
    strategy:
      fail-fast: false
      matrix:
        os: ["windows-latest", "macos-latest", "ubuntu-latest"]
        example: ["hello", "gem", "native", "pact_broker"]
        shell:
          - bash
          - sh
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      with:
        name: ${{ matrix.example }}-pkg
        path: examples/${{ matrix.example }}/pkg
      uses: actions/download-artifact@v4
    - name: test ${{ matrix.os }} package
      run: ./script/unpack-and-test.sh
      env:
        APP_NAME: ${{ matrix.example }}
    - name: Run hello via PowerShell (Windows only)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        powershell -Command "examples/${{ matrix.example }}/pkg/test-app/hello.bat"
    - name: Run hello via CMD (Windows only)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cmd /C examples\${{ matrix.example }}\pkg\test-app\hello.bat
  
  test-win-arm:
    defaults:
      run:
        shell: ${{ matrix.shell }}
    needs: [package]
    strategy:
      fail-fast: false
      matrix:
        os: ["windows-11-arm"]
        example: ["hello", "gem", "native", "pact_broker"]
        shell:
          - bash
          - sh
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      with:
        name: ${{ matrix.example }}-pkg
        path: examples/${{ matrix.example }}/pkg
      uses: actions/download-artifact@v4
    - name: test ${{ matrix.os }} package
      run: ./script/unpack-and-test.sh
      env:
        BINARY_ARCH: arm64
        BINARY_OS: windows
        APP_NAME: ${{ matrix.example }}
    - name: Run hello via PowerShell (Windows only)
      shell: powershell
      if: runner.os == 'Windows'
      run: |
        powershell -Command "examples/${{ matrix.example }}/pkg/test-app/hello.bat"
    - name: Run hello via CMD (Windows only)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cmd /C examples\${{ matrix.example }}\pkg\test-app\hello.bat
  
  test-linux-musl:
    needs: [package]
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    strategy:
      fail-fast: true
      matrix:
        example: ["hello", "gem", "native", "pact_broker"]
    steps:
    - uses: actions/checkout@v5
    - name: Install dependencies
      run: apk add --no-cache curl
    - name: Download all workflow run artifacts
      with:
        name: ${{ matrix.example }}-pkg
        path: examples/${{ matrix.example }}/pkg
      uses: actions/download-artifact@v4
    - name: test musl package
      run: ./script/unpack-and-test.sh
      env:
        BINARY_ARCH: x86_64
        BINARY_OS: linux-musl
        APP_NAME: ${{ matrix.example }}

  test-linux-musl-arm:
    needs: [package]
    runs-on: ubuntu-22.04-arm
    strategy:
      fail-fast: true
      matrix:
        example: ["hello","gem"]
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      with:
        name: ${{ matrix.example }}-pkg
        path: examples/${{ matrix.example }}/pkg
      uses: actions/download-artifact@v4
    - name: Test in alpine container
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/workspace" \
          -e BINARY_ARCH=arm64 \
          -e BINARY_OS=linux-musl \
          -e APP_NAME=${{ matrix.example }} \
          alpine:latest /bin/sh -c "
            apk add --no-cache curl && \
            cd /workspace && \
            ./script/unpack-and-test.sh
          "
